# WAF設定ガイド

このガイドでは、Dify on AWSでWAF（Web Application Firewall）を設定する方法を説明します。

## 概要

WAFを使用することで、特定のIPアドレスや国からのアクセスのみを許可し、セキュリティを向上させることができます。

## 環境変数の設定

WAF設定は環境変数を使用して管理します。以下の環境変数を設定してください：

### 1. IPv4アドレス制限

```bash
# 特定のIPアドレス範囲を許可
export ALLOWED_IPV4_CIDRS="203.0.113.0/24,198.51.100.0/24,192.168.1.100/32"

# すべてのIPアドレスを許可（デフォルト）
export ALLOWED_IPV4_CIDRS="0.0.0.0/0"
```

### 2. IPv6アドレス制限

```bash
# 特定のIPv6アドレス範囲を許可
export ALLOWED_IPV6_CIDRS="2001:db8::/64"

# 設定しない場合は制限なし
```

### 3. 国別制限

```bash
# 特定の国からのアクセスのみ許可
export ALLOWED_COUNTRY_CODES="JP,US"

# 設定しない場合は制限なし
```

## 設定例

### 例1: オフィスネットワークのみ許可

```bash
export ALLOWED_IPV4_CIDRS="203.0.113.0/24"
export ALLOWED_COUNTRY_CODES="JP"
```

### 例2: 複数のIPアドレス範囲を許可

```bash
export ALLOWED_IPV4_CIDRS="203.0.113.0/24,198.51.100.0/24,192.168.1.100/32"
```

### 例3: 特定の国のみ許可

```bash
export ALLOWED_COUNTRY_CODES="JP,US"
```

### 例4: 制限なし（すべてのアクセスを許可）

```bash
# 環境変数を設定しないか、以下のように設定
export ALLOWED_IPV4_CIDRS="0.0.0.0/0"
```

## デプロイ手順

1. 環境変数を設定します：
   ```bash
   export ALLOWED_IPV4_CIDRS="203.0.113.0/24"
   export ALLOWED_COUNTRY_CODES="JP"
   ```

2. CDKをデプロイします：
   ```bash
   npx cdk deploy --all
   ```

3. デプロイ完了後、WAFが有効になっていることを確認します。

## 注意事項

1. **CloudFront統合**: WAFはCloudFrontと統合されて動作します
2. **リージョン**: WAFはus-east-1リージョンに作成されます（CloudFront要件）
3. **デフォルト動作**: 許可されていないIPアドレスや国からのアクセスはブロックされます
4. **設定変更**: 設定を変更した後は `npx cdk deploy --all` で再デプロイが必要です

## トラブルシューティング

- WAFが有効になっている場合、許可されていないIPアドレスからアクセスすると403エラーが表示されます
- CloudWatchでWAFのメトリクスを確認できます
- WAFルールの優先順位は自動的に設定されます

## 環境変数の詳細

| 環境変数名 | 説明 | 例 | デフォルト |
|-----------|------|-----|-----------|
| `ALLOWED_IPV4_CIDRS` | 許可するIPv4アドレス範囲（CIDR形式） | `203.0.113.0/24,198.51.100.0/24` | `0.0.0.0/0` |
| `ALLOWED_IPV6_CIDRS` | 許可するIPv6アドレス範囲（CIDR形式） | `2001:db8::/64` | 制限なし |
| `ALLOWED_COUNTRY_CODES` | 許可する国コード（ISO 3166-1 alpha-2） | `JP,US` | 制限なし |

## セキュリティのベストプラクティス

1. **最小権限の原則**: 必要最小限のIPアドレス範囲のみを許可する
2. **定期的な見直し**: 許可リストを定期的に見直し、不要なエントリを削除する
3. **ログ監視**: CloudWatchでWAFのログを監視し、不正なアクセスを検出する
4. **段階的な制限**: 最初は緩い制限から始めて、徐々に厳しくする 